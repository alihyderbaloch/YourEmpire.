{"file_contents":{"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"flask>=3.1.2\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"pillow>=12.0.0\",\n    \"psycopg2-binary>=2.9.11\",\n    \"python-dotenv>=1.2.1\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":299},"app.py":{"content":"import os\nimport json\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom werkzeug.utils import secure_filename\nfrom flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify, send_from_directory\nfrom models import db, User, Admin, MasterAdmin, Package, Payment, Withdrawal, PaymentMethod, Ad, AdView, Settings, Announcement, GuideVideo, PasswordResetRequest, ProfileUpdateRequest, LoginHistory\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\napp = Flask(__name__)\napp.secret_key = os.environ.get('SESSION_SECRET', 'yourempire-secret-key-change-in-production')\napp.config['MAX_CONTENT_LENGTH'] = 5 * 1024 * 1024\napp.config['UPLOAD_FOLDER'] = 'static/uploads'\napp.config['ADS_FOLDER'] = 'static/ads'\napp.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL', 'sqlite:///yourempire.db')\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\napp.config['SQLALCHEMY_ENGINE_OPTIONS'] = {\n    'pool_pre_ping': True,\n    'pool_recycle': 3600,\n    'pool_size': 10,\n    'max_overflow': 20,\n    'connect_args': {'connect_timeout': 10, 'sslmode': 'allow'}\n}\n\nALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'pdf', 'mp4', 'webm'}\n\ndb.init_app(app)\n\ndef allowed_file(filename):\n    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS\n\ndef login_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Please log in first.', 'error')\n            return redirect(url_for('login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'admin_id' not in session and 'master_admin_id' not in session:\n            flash('Admin access required.', 'error')\n            return redirect(url_for('admin_login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef master_admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'master_admin_id' not in session:\n            flash('Master Admin access required.', 'error')\n            return redirect(url_for('admin_login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef get_setting(key, default=None):\n    setting = Settings.query.filter_by(key=key).first()\n    return setting.value if setting else default\n\ndef set_setting(key, value):\n    setting = Settings.query.filter_by(key=key).first()\n    if setting:\n        setting.value = str(value)\n    else:\n        setting = Settings(key=key, value=str(value))\n        db.session.add(setting)\n    db.session.commit()\n\ndef init_default_settings():\n    if not Settings.query.first():\n        defaults = {\n            'commission_percentage': '50',\n            'min_withdrawal': '225',\n            'ads_enabled': 'true',\n            'maintenance_mode': 'false'\n        }\n        for key, value in defaults.items():\n            setting = Settings(key=key, value=value)\n            db.session.add(setting)\n        db.session.commit()\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        email = request.form.get('email')\n        password = request.form.get('password')\n        full_name = request.form.get('full_name')\n        phone = request.form.get('phone')\n        city = request.form.get('city')\n        address = request.form.get('address', '')\n        referral_code = request.form.get('referral_code', '').strip()\n        \n        if len(password) < 8:\n            flash('Password must be at least 8 characters!', 'error')\n            return redirect(url_for('register'))\n        \n        if User.query.filter_by(email=email).first():\n            flash('Email already registered!', 'error')\n            return redirect(url_for('register'))\n        \n        referred_by = None\n        if referral_code:\n            referrer = User.query.filter_by(referral_code=referral_code).first()\n            if referrer:\n                referred_by = referrer.id\n            else:\n                flash('Invalid referral code!', 'error')\n                return redirect(url_for('register'))\n        \n        new_user = User(\n            email=email,\n            full_name=full_name,\n            phone=phone,\n            city=city,\n            address=address,\n            referral_code=User.generate_referral_code(),\n            referred_by=referred_by\n        )\n        new_user.set_password(password)\n        \n        db.session.add(new_user)\n        db.session.commit()\n        \n        flash('Registration successful! Please log in.', 'success')\n        return redirect(url_for('login'))\n    \n    ref_code = request.args.get('ref', '')\n    return render_template('register.html', ref_code=ref_code)\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    maintenance = get_setting('maintenance_mode', 'false').lower() == 'true'\n    if maintenance and request.method == 'POST':\n        return render_template('maintenance.html'), 503\n    \n    if request.method == 'POST':\n        email = request.form.get('email')\n        password = request.form.get('password')\n        \n        # Check Master Admin first\n        master_admin = MasterAdmin.query.filter_by(email=email).first()\n        if master_admin and master_admin.check_password(password):\n            session['master_admin_id'] = master_admin.id\n            session['admin_email'] = email\n            login_log = LoginHistory(master_admin_id=master_admin.id, login_type='master', ip_address=request.remote_addr)\n            db.session.add(login_log)\n            db.session.commit()\n            flash('Master Admin login successful!', 'success')\n            return redirect(url_for('master_admin_dashboard'))\n        \n        # Check Admin\n        admin = Admin.query.filter_by(email=email, is_active=True).first()\n        if admin and admin.check_password(password):\n            session['admin_id'] = admin.id\n            session['admin_email'] = email\n            login_log = LoginHistory(admin_id=admin.id, login_type='admin', ip_address=request.remote_addr)\n            db.session.add(login_log)\n            db.session.commit()\n            flash('Admin login successful!', 'success')\n            return redirect(url_for('admin_dashboard'))\n        \n        # Check Regular User\n        user = User.query.filter_by(email=email, is_active=True).first()\n        if user and user.check_password(password):\n            session['user_id'] = user.id\n            session['user_name'] = user.full_name\n            login_log = LoginHistory(user_id=user.id, login_type='user', ip_address=request.remote_addr)\n            db.session.add(login_log)\n            db.session.commit()\n            flash(f'Welcome back, {user.full_name}!', 'success')\n            return redirect(url_for('user_dashboard'))\n        \n        flash('Invalid email or password!', 'error')\n        return redirect(url_for('login'))\n    \n    return render_template('login.html')\n\n@app.route('/admin-login', methods=['GET', 'POST'])\ndef admin_login():\n    # Redirect to unified login page\n    return redirect(url_for('login'))\n\n@app.route('/logout')\ndef logout():\n    session.clear()\n    flash('Logged out successfully!', 'success')\n    return redirect(url_for('index'))\n\n@app.route('/forgot-password', methods=['GET', 'POST'])\ndef forgot_password():\n    if request.method == 'POST':\n        email = request.form.get('email')\n        user = User.query.filter_by(email=email).first()\n        \n        if user:\n            existing_request = PasswordResetRequest.query.filter_by(user_id=user.id, status='Pending').first()\n            if not existing_request:\n                reset_request = PasswordResetRequest(user_id=user.id)\n                db.session.add(reset_request)\n                db.session.commit()\n                flash('Password reset request submitted. Master Admin will contact you soon.', 'success')\n            else:\n                flash('You already have a pending reset request.', 'info')\n        else:\n            flash('Email not found!', 'error')\n        \n        return redirect(url_for('login'))\n    \n    return render_template('forgot_password.html')\n\n@app.route('/dashboard')\n@login_required\ndef user_dashboard():\n    user = User.query.get(session['user_id'])\n    if not user:\n        session.clear()\n        return redirect(url_for('login'))\n    \n    payments = Payment.query.filter_by(user_id=user.id).all()\n    withdrawals = Withdrawal.query.filter_by(user_id=user.id).all()\n    ad_views = AdView.query.filter_by(user_id=user.id).all()\n    total_ad_earnings = sum(av.ad.reward for av in ad_views)\n    ads_enabled = get_setting('ads_enabled', 'true').lower() == 'true'\n    referrals = User.query.filter_by(referred_by=user.id).all()\n    announcements = Announcement.query.filter_by(is_active=True).all()\n    guide_videos = GuideVideo.query.all()\n    \n    return render_template('user_dashboard.html', \n                         user=user, \n                         payments=payments,\n                         withdrawals=withdrawals,\n                         ads_enabled=ads_enabled,\n                         total_ad_earnings=total_ad_earnings,\n                         referrals=referrals,\n                         announcements=announcements,\n                         guide_videos=guide_videos)\n\n@app.route('/user-profile')\n@login_required\ndef user_profile():\n    user = User.query.get(session['user_id'])\n    referral_tree = []\n    \n    def build_tree(u):\n        return {\n            'id': u.id,\n            'name': u.full_name,\n            'email': u.email,\n            'is_invested': u.is_invested,\n            'children': [build_tree(ref) for ref in u.referred_users]\n        }\n    \n    referral_tree = build_tree(user)\n    pending_updates = ProfileUpdateRequest.query.filter_by(user_id=user.id, status='Pending').all()\n    \n    return render_template('user_profile.html', user=user, referral_tree=referral_tree, pending_updates=pending_updates)\n\n@app.route('/update-profile', methods=['POST'])\n@login_required\ndef update_profile():\n    user = User.query.get(session['user_id'])\n    update_type = request.form.get('update_type')\n    new_value = request.form.get('new_value')\n    \n    if update_type == 'password' and len(new_value) < 8:\n        flash('Password must be at least 8 characters!', 'error')\n        return redirect(url_for('user_profile'))\n    \n    update_request = ProfileUpdateRequest(user_id=user.id, update_type=update_type, new_value=new_value)\n    db.session.add(update_request)\n    db.session.commit()\n    \n    flash('Update request submitted. Admin will review it.', 'success')\n    return redirect(url_for('user_profile'))\n\n@app.route('/buy-package', methods=['GET', 'POST'])\n@login_required\ndef buy_package():\n    if request.method == 'POST':\n        package_id = int(request.form.get('package_id'))\n        payment_method_id = int(request.form.get('payment_method'))\n        transaction_id = request.form.get('transaction_id')\n        \n        package = Package.query.get(package_id)\n        payment_method = PaymentMethod.query.get(payment_method_id)\n        \n        if not package or not payment_method:\n            flash('Invalid package or payment method!', 'error')\n            return redirect(url_for('buy_package'))\n        \n        screenshot = None\n        if 'screenshot' in request.files:\n            file = request.files['screenshot']\n            if file and file.filename and allowed_file(file.filename):\n                filename = secure_filename(f\"{session['user_id']}_{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\n                file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))\n                screenshot = filename\n        \n        new_payment = Payment(\n            user_id=session['user_id'],\n            package_id=package_id,\n            amount=package.price,\n            payment_method_id=payment_method_id,\n            transaction_id=transaction_id,\n            screenshot=screenshot\n        )\n        \n        db.session.add(new_payment)\n        db.session.commit()\n        \n        flash('Payment submitted successfully! Waiting for admin approval.', 'success')\n        return redirect(url_for('user_dashboard'))\n    \n    packages = Package.query.all()\n    payment_methods = PaymentMethod.query.all()\n    \n    return render_template('buy_package.html', packages=packages, payment_methods=payment_methods)\n\n@app.route('/withdraw', methods=['GET', 'POST'])\n@login_required\ndef withdraw():\n    user = User.query.get(session['user_id'])\n    min_withdrawal = float(get_setting('min_withdrawal', 225))\n    \n    if request.method == 'POST':\n        amount = float(request.form.get('amount'))\n        payment_method = request.form.get('payment_method')\n        account_number = request.form.get('account_number')\n        account_name = request.form.get('account_name')\n        \n        if amount < min_withdrawal:\n            flash(f'Minimum withdrawal amount is {min_withdrawal} PKR!', 'error')\n            return redirect(url_for('withdraw'))\n        \n        if amount > user.wallet_balance:\n            flash('Insufficient balance!', 'error')\n            return redirect(url_for('withdraw'))\n        \n        new_withdrawal = Withdrawal(\n            user_id=user.id,\n            amount=amount,\n            payment_method=payment_method,\n            account_number=account_number,\n            account_name=account_name\n        )\n        \n        db.session.add(new_withdrawal)\n        db.session.commit()\n        \n        flash('Withdrawal request submitted! Waiting for admin approval.', 'success')\n        return redirect(url_for('user_dashboard'))\n    \n    return render_template('withdraw.html', user=user, min_withdrawal=min_withdrawal)\n\n@app.route('/watch-ads')\n@login_required\ndef watch_ads():\n    ads_enabled = get_setting('ads_enabled', 'true').lower() == 'true'\n    if not ads_enabled:\n        flash('Ad section is currently disabled.', 'info')\n        return redirect(url_for('user_dashboard'))\n    \n    today = datetime.utcnow().strftime('%Y-%m-%d')\n    user_today_views = db.session.query(AdView).filter(\n        AdView.user_id == session['user_id'],\n        db.func.date(AdView.viewed_at) == today\n    ).all()\n    viewed_ad_ids = [av.ad_id for av in user_today_views]\n    \n    available_ads = Ad.query.filter(Ad.is_active == True, Ad.id.notin_(viewed_ad_ids)).all()\n    ad_history = AdView.query.filter_by(user_id=session['user_id']).all()\n    \n    return render_template('watch_ads.html', ads=available_ads, ad_history=ad_history)\n\n@app.route('/view-ad/<int:ad_id>')\n@login_required\ndef view_ad(ad_id):\n    ad = Ad.query.get(ad_id)\n    \n    if not ad:\n        flash('Ad not found!', 'error')\n        return redirect(url_for('watch_ads'))\n    \n    today = datetime.utcnow().strftime('%Y-%m-%d')\n    already_viewed = db.session.query(AdView).filter(\n        AdView.user_id == session['user_id'],\n        AdView.ad_id == ad_id,\n        db.func.date(AdView.viewed_at) == today\n    ).first()\n    \n    if already_viewed:\n        flash('You have already viewed this ad today!', 'info')\n        return redirect(url_for('watch_ads'))\n    \n    new_view = AdView(user_id=session['user_id'], ad_id=ad_id)\n    db.session.add(new_view)\n    \n    user = User.query.get(session['user_id'])\n    user.wallet_balance += ad.reward\n    \n    db.session.commit()\n    \n    flash(f'You earned {ad.reward} PKR for viewing this ad!', 'success')\n    return redirect(url_for('watch_ads'))\n\n@app.route('/master-admin/dashboard')\n@master_admin_required\ndef master_admin_dashboard():\n    total_users = User.query.count()\n    total_admins = Admin.query.count()\n    pending_password_resets = PasswordResetRequest.query.filter_by(status='Pending').count()\n    pending_profile_updates = ProfileUpdateRequest.query.filter_by(status='Pending').count()\n    \n    stats = {\n        'total_users': total_users,\n        'total_admins': total_admins,\n        'pending_password_resets': pending_password_resets,\n        'pending_profile_updates': pending_profile_updates\n    }\n    \n    admins = Admin.query.all()\n    return render_template('master_admin_dashboard.html', stats=stats, admins=admins)\n\n@app.route('/master-admin/add-admin', methods=['POST'])\n@master_admin_required\ndef add_admin():\n    email = request.form.get('email')\n    password = request.form.get('password')\n    \n    if Admin.query.filter_by(email=email).first():\n        flash('Email already exists!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    new_admin = Admin(email=email, created_by_master_id=session['master_admin_id'])\n    new_admin.set_password(password)\n    \n    db.session.add(new_admin)\n    db.session.commit()\n    \n    flash('Admin added successfully!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/deactivate-admin/<int:admin_id>')\n@master_admin_required\ndef deactivate_admin(admin_id):\n    admin = Admin.query.get(admin_id)\n    if admin:\n        admin.is_active = False\n        db.session.commit()\n        flash('Admin deactivated!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/approve-password-reset/<int:request_id>', methods=['POST'])\n@master_admin_required\ndef approve_password_reset(request_id):\n    new_password = request.form.get('new_password')\n    reset_req = PasswordResetRequest.query.get(request_id)\n    \n    if reset_req and len(new_password) >= 8:\n        reset_req.status = 'Resolved'\n        reset_req.resolved_by_master_admin_id = session['master_admin_id']\n        reset_req.resolved_at = datetime.utcnow()\n        \n        user = reset_req.user\n        user.set_password(new_password)\n        \n        db.session.commit()\n        flash('Password reset completed!', 'success')\n    else:\n        flash('Invalid request or password!', 'error')\n    \n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/maintenance-mode', methods=['POST'])\n@master_admin_required\ndef toggle_maintenance_mode():\n    current = get_setting('maintenance_mode', 'false').lower() == 'true'\n    set_setting('maintenance_mode', 'false' if current else 'true')\n    flash('Maintenance mode toggled!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/change-master-password', methods=['POST'])\n@master_admin_required\ndef change_master_admin_password():\n    current_password = request.form.get('current_password')\n    new_password = request.form.get('new_password')\n    confirm_password = request.form.get('confirm_password')\n    \n    master_admin = MasterAdmin.query.get(session['master_admin_id'])\n    \n    if not master_admin:\n        flash('Master Admin not found!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    if not master_admin.check_password(current_password):\n        flash('Current password is incorrect!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    if len(new_password) < 8:\n        flash('Password must be at least 8 characters!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    if new_password != confirm_password:\n        flash('Passwords do not match!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    master_admin.set_password(new_password)\n    db.session.commit()\n    flash('Master Admin password changed successfully!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/change-user-password', methods=['POST'])\n@master_admin_required\ndef admin_change_user_password():\n    user_email = request.form.get('user_email')\n    new_password = request.form.get('new_password')\n    \n    if len(new_password) < 8:\n        flash('Password must be at least 8 characters!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    user = User.query.filter_by(email=user_email).first()\n    \n    if not user:\n        flash('User not found!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    user.set_password(new_password)\n    db.session.commit()\n    flash(f'Password changed for user {user_email}!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/master-admin/change-admin-password', methods=['POST'])\n@master_admin_required\ndef admin_change_admin_password():\n    admin_email = request.form.get('admin_email')\n    new_password = request.form.get('new_password')\n    \n    if len(new_password) < 8:\n        flash('Password must be at least 8 characters!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    admin = Admin.query.filter_by(email=admin_email).first()\n    \n    if not admin:\n        flash('Admin not found!', 'error')\n        return redirect(url_for('master_admin_dashboard'))\n    \n    admin.set_password(new_password)\n    db.session.commit()\n    flash(f'Password changed for admin {admin_email}!', 'success')\n    return redirect(url_for('master_admin_dashboard'))\n\n@app.route('/admin/dashboard')\n@admin_required\ndef admin_dashboard():\n    users = User.query.all()\n    payments = Payment.query.all()\n    withdrawals = Withdrawal.query.all()\n    packages = Package.query.all()\n    ads = Ad.query.all()\n    payment_methods = PaymentMethod.query.all()\n    \n    # Get all settings\n    settings_list = Settings.query.all()\n    settings = {s.key: s.value for s in settings_list}\n    \n    stats = {\n        'total_users': len(users),\n        'total_payments': len([p for p in payments if p.status == 'Approved']),\n        'total_withdrawals': len([w for w in withdrawals if w.status == 'Approved']),\n        'pending_payments': len([p for p in payments if p.status == 'Pending']),\n        'pending_withdrawals': len([w for w in withdrawals if w.status == 'Pending']),\n        'total_ad_views': len(AdView.query.all())\n    }\n    \n    return render_template('admin_dashboard.html', \n                         users=users,\n                         payments=payments,\n                         withdrawals=withdrawals,\n                         packages=packages,\n                         ads=ads,\n                         payment_methods=payment_methods,\n                         settings=settings,\n                         stats=stats)\n\n@app.route('/admin/approve-payment/<int:payment_id>')\n@admin_required\ndef approve_payment(payment_id):\n    payment = Payment.query.get(payment_id)\n    \n    if payment and payment.status == 'Pending':\n        payment.status = 'Approved'\n        payment.approved_by_admin_id = session.get('admin_id')\n        \n        commission_rate = float(get_setting('commission_percentage', 50)) / 100\n        user = payment.user\n        \n        if user.referred_by:\n            commission = payment.amount * commission_rate\n            referrer = User.query.get(user.referred_by)\n            referrer.wallet_balance += commission\n            flash(f'Payment approved! Commission of {commission} PKR credited to referrer.', 'success')\n        else:\n            flash('Payment approved!', 'success')\n        \n        db.session.commit()\n    \n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/approve-payment-screenshot/<int:payment_id>')\n@admin_required\ndef view_payment_screenshot(payment_id):\n    payment = Payment.query.get(payment_id)\n    if payment and payment.screenshot:\n        return send_from_directory(app.config['UPLOAD_FOLDER'], payment.screenshot)\n    return \"File not found\", 404\n\n@app.route('/admin/reject-payment/<int:payment_id>')\n@admin_required\ndef reject_payment(payment_id):\n    payment = Payment.query.get(payment_id)\n    if payment:\n        payment.status = 'Rejected'\n        db.session.commit()\n        flash('Payment rejected!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/approve-withdrawal/<int:withdrawal_id>')\n@admin_required\ndef approve_withdrawal(withdrawal_id):\n    withdrawal = Withdrawal.query.get(withdrawal_id)\n    \n    if withdrawal and withdrawal.status == 'Pending':\n        user = withdrawal.user\n        \n        if user.wallet_balance >= withdrawal.amount:\n            withdrawal.status = 'Approved'\n            withdrawal.approved_by_admin_id = session.get('admin_id')\n            user.wallet_balance -= withdrawal.amount\n            db.session.commit()\n            flash('Withdrawal approved and amount deducted from wallet!', 'success')\n        else:\n            flash('User has insufficient balance!', 'error')\n    \n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/reject-withdrawal/<int:withdrawal_id>')\n@admin_required\ndef reject_withdrawal(withdrawal_id):\n    withdrawal = Withdrawal.query.get(withdrawal_id)\n    if withdrawal:\n        withdrawal.status = 'Rejected'\n        db.session.commit()\n        flash('Withdrawal rejected!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/mark-invested/<int:user_id>')\n@admin_required\ndef mark_invested(user_id):\n    user = User.query.get(user_id)\n    if user:\n        user.is_invested = True\n        db.session.commit()\n        flash('User marked as invested!', 'success')\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/view-user-tree/<int:user_id>')\n@admin_required\ndef view_user_tree(user_id):\n    user = User.query.get(user_id)\n    if not user:\n        flash('User not found!', 'error')\n        return redirect(url_for('admin_dashboard'))\n    \n    def build_tree(u, depth=0):\n        if depth > 10:\n            return None\n        return {\n            'id': u.id,\n            'name': u.full_name,\n            'email': u.email,\n            'is_invested': u.is_invested,\n            'wallet': u.wallet_balance,\n            'children': [build_tree(ref, depth+1) for ref in u.referred_users]\n        }\n    \n    tree = build_tree(user)\n    return render_template('user_tree.html', user=user, tree=tree)\n\n@app.route('/admin/profile-updates')\n@admin_required\ndef profile_updates():\n    pending_updates = ProfileUpdateRequest.query.filter_by(status='Pending').all()\n    return render_template('profile_updates.html', updates=pending_updates)\n\n@app.route('/admin/approve-profile-update/<int:update_id>')\n@admin_required\ndef approve_profile_update(update_id):\n    update_req = ProfileUpdateRequest.query.get(update_id)\n    \n    if update_req:\n        user = update_req.user\n        update_req.status = 'Approved'\n        update_req.approved_by_admin_id = session.get('admin_id')\n        \n        if update_req.update_type == 'phone':\n            user.phone = update_req.new_value\n        elif update_req.update_type == 'city':\n            user.city = update_req.new_value\n        elif update_req.update_type == 'address':\n            user.address = update_req.new_value\n        elif update_req.update_type == 'password':\n            user.set_password(update_req.new_value)\n        \n        db.session.commit()\n        flash('Profile update approved!', 'success')\n    \n    return redirect(url_for('profile_updates'))\n\n@app.route('/admin/reject-profile-update/<int:update_id>')\n@admin_required\ndef reject_profile_update(update_id):\n    update_req = ProfileUpdateRequest.query.get(update_id)\n    if update_req:\n        update_req.status = 'Rejected'\n        db.session.commit()\n        flash('Profile update rejected!', 'success')\n    return redirect(url_for('profile_updates'))\n\n@app.route('/admin/manage-payment-methods', methods=['POST'])\n@admin_required\ndef manage_payment_methods():\n    action = request.form.get('action')\n    \n    if action == 'add':\n        new_method = PaymentMethod(\n            type=request.form.get('type'),\n            account_number=request.form.get('account_number'),\n            account_name=request.form.get('account_name'),\n            bank_name=request.form.get('bank_name', '')\n        )\n        db.session.add(new_method)\n        flash('Payment method added!', 'success')\n    \n    elif action == 'edit':\n        method = PaymentMethod.query.get(int(request.form.get('method_id')))\n        if method:\n            method.type = request.form.get('type')\n            method.account_number = request.form.get('account_number')\n            method.account_name = request.form.get('account_name')\n            method.bank_name = request.form.get('bank_name', '')\n            flash('Payment method updated!', 'success')\n    \n    elif action == 'delete':\n        method = PaymentMethod.query.get(int(request.form.get('method_id')))\n        if method:\n            db.session.delete(method)\n            flash('Payment method deleted!', 'success')\n    \n    db.session.commit()\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/manage-packages', methods=['POST'])\n@admin_required\ndef manage_packages():\n    action = request.form.get('action')\n    \n    if action == 'add':\n        new_package = Package(\n            name=request.form.get('name'),\n            price=float(request.form.get('price')),\n            description=request.form.get('description', '')\n        )\n        db.session.add(new_package)\n        flash('Package added!', 'success')\n    \n    elif action == 'edit':\n        package = Package.query.get(int(request.form.get('package_id')))\n        if package:\n            package.name = request.form.get('name')\n            package.price = float(request.form.get('price'))\n            package.description = request.form.get('description', '')\n            flash('Package updated!', 'success')\n    \n    elif action == 'delete':\n        package = Package.query.get(int(request.form.get('package_id')))\n        if package:\n            db.session.delete(package)\n            flash('Package deleted!', 'success')\n    \n    db.session.commit()\n    return redirect(url_for('admin_dashboard'))\n\n@app.route('/admin/manage-ads', methods=['GET', 'POST'])\n@admin_required\ndef manage_ads():\n    if request.method == 'POST':\n        action = request.form.get('action')\n        \n        if action == 'add':\n            ad_type = request.form.get('ad_type')\n            media_file = None\n            link = None\n            \n            if ad_type in ['video', 'image']:\n                if 'media_file' in request.files:\n                    file = request.files['media_file']\n                    if file and file.filename and allowed_file(file.filename):\n                        filename = secure_filename(f\"ad_{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                        os.makedirs(app.config['ADS_FOLDER'], exist_ok=True)\n                        file.save(os.path.join(app.config['ADS_FOLDER'], filename))\n                        media_file = filename\n            elif ad_type == 'link':\n                link = request.form.get('link')\n            \n            new_ad = Ad(\n                title=request.form.get('title'),\n                type=ad_type,\n                media_file=media_file,\n                link=link,\n                reward=float(request.form.get('reward'))\n            )\n            db.session.add(new_ad)\n            flash('Ad added!', 'success')\n        \n        elif action == 'delete':\n            ad = Ad.query.get(int(request.form.get('ad_id')))\n            if ad:\n                db.session.delete(ad)\n                flash('Ad deleted!', 'success')\n        \n        db.session.commit()\n    \n    ads = Ad.query.all()\n    return render_template('manage_ads.html', ads=ads)\n\n@app.route('/admin/manage-announcements', methods=['GET', 'POST'])\n@admin_required\ndef manage_announcements():\n    if request.method == 'POST':\n        action = request.form.get('action')\n        \n        if action == 'add':\n            ann_type = request.form.get('announcement_type')\n            media_file = None\n            \n            if ann_type in ['image', 'video']:\n                if 'media_file' in request.files:\n                    file = request.files['media_file']\n                    if file and file.filename and allowed_file(file.filename):\n                        filename = secure_filename(f\"ann_{datetime.now().strftime('%Y%m%d%H%M%S')}_{file.filename}\")\n                        os.makedirs(app.config['ADS_FOLDER'], exist_ok=True)\n                        file.save(os.path.join(app.config['ADS_FOLDER'], filename))\n                        media_file = filename\n            \n            new_ann = Announcement(\n                type=ann_type,\n                content=request.form.get('content'),\n                media_file=media_file\n            )\n            db.session.add(new_ann)\n            flash('Announcement added!', 'success')\n        \n        db.session.commit()\n    \n    announcements = Announcement.query.all()\n    return render_template('manage_announcements.html', announcements=announcements)\n\n@app.route('/admin/toggle-announcement/<int:ann_id>')\n@admin_required\ndef toggle_announcement(ann_id):\n    ann = Announcement.query.get(ann_id)\n    if ann:\n        ann.is_active = not ann.is_active\n        db.session.commit()\n        flash('Announcement toggled!', 'success')\n    return redirect(url_for('manage_announcements'))\n\n@app.route('/admin/manage-guide-videos', methods=['GET', 'POST'])\n@admin_required\ndef manage_guide_videos():\n    if request.method == 'POST':\n        action = request.form.get('action')\n        \n        if action == 'add':\n            new_video = GuideVideo(\n                title=request.form.get('title'),\n                video_url=request.form.get('video_url')\n            )\n            db.session.add(new_video)\n            db.session.commit()\n            flash('Guide video added!', 'success')\n        \n        elif action == 'delete':\n            video = GuideVideo.query.get(int(request.form.get('video_id')))\n            if video:\n                db.session.delete(video)\n                db.session.commit()\n                flash('Guide video deleted!', 'success')\n    \n    videos = GuideVideo.query.all()\n    return render_template('manage_guide_videos.html', videos=videos)\n\n@app.route('/admin/settings', methods=['GET', 'POST'])\n@admin_required\ndef admin_settings():\n    if request.method == 'POST':\n        set_setting('commission_percentage', request.form.get('commission_percentage'))\n        set_setting('min_withdrawal', request.form.get('min_withdrawal'))\n        set_setting('ads_enabled', 'true' if request.form.get('ads_enabled') else 'false')\n        flash('Settings updated!', 'success')\n        return redirect(url_for('admin_settings'))\n    \n    settings = {\n        'commission_percentage': get_setting('commission_percentage', 50),\n        'min_withdrawal': get_setting('min_withdrawal', 225),\n        'ads_enabled': get_setting('ads_enabled', 'true').lower() == 'true'\n    }\n    \n    return render_template('admin_settings.html', settings=settings)\n\n@app.route('/admin/adjust-wallet/<int:user_id>', methods=['POST'])\n@admin_required\ndef adjust_wallet(user_id):\n    user = User.query.get(user_id)\n    if user:\n        try:\n            amount = float(request.form.get('amount', 0))\n            user.wallet_balance += amount\n            db.session.commit()\n            if amount >= 0:\n                flash(f'Added {amount} PKR to {user.full_name}\\'s wallet!', 'success')\n            else:\n                flash(f'Deducted {abs(amount)} PKR from {user.full_name}\\'s wallet!', 'success')\n        except ValueError:\n            flash('Invalid amount!', 'error')\n    return redirect(url_for('admin_dashboard'))\n\n@app.errorhandler(404)\ndef not_found(error):\n    return render_template('404.html'), 404\n\n@app.errorhandler(500)\ndef server_error(error):\n    return render_template('500.html'), 500\n\nif __name__ == '__main__':\n    with app.app_context():\n        db.create_all()\n        init_default_settings()\n        os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\n        os.makedirs(app.config['ADS_FOLDER'], exist_ok=True)\n    \n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":35911},"replit.md":{"content":"# YourEmpire - Network Marketing Platform\n\n## Overview\nYourEmpire is a complete full-stack network marketing platform built with Flask, Python, and TailwindCSS. It features a referral system, package purchases, wallet management, ad watching rewards, and comprehensive admin controls. All data is stored locally in JSON files for 100% offline operation.\n\n## Key Features\n\n### User Features\n- **Registration & Login**: Secure user authentication with password hashing\n- **Referral System**: Auto-generated referral codes (YE####) with commission tracking\n- **Package Purchases**: Buy packages (Bronze, Silver, Diamond, Platinum) via multiple payment methods\n- **Wallet System**: Track earnings, commissions, and ad rewards\n- **Withdrawal Requests**: Request withdrawals to Easypaisa, JazzCash, or bank accounts\n- **Ad Watching**: Earn micro-rewards (PKR) by viewing ads uploaded by admin\n- **Dashboard**: View referral code, wallet balance, payment/withdrawal history\n\n### Admin Features\n- **User Management**: View all users, adjust wallet balances manually\n- **Payment Method Management**: Add/edit/delete payment methods (Easypaisa, JazzCash, bank accounts) with account details\n- **Payment Approval**: Approve or reject user package purchases\n- **Withdrawal Management**: Approve or reject withdrawal requests\n- **Package Management**: Add, edit, or delete packages\n- **Commission Settings**: Adjust global commission percentage (default 50%)\n- **Withdrawal Limits**: Set minimum withdrawal amount\n- **Ad Management**: Upload video/image/link ads, set rewards per view, track analytics\n- **System Settings**: Enable/disable ad section, set contact information\n- **Password Management**: Change admin password\n\n## Technology Stack\n- **Backend**: Flask (Python 3.11)\n- **Frontend**: TailwindCSS via CDN\n- **Data Storage**: JSON files (users.json, packages.json, payments.json, withdraws.json, ads.json, ad_views.json, settings.json)\n- **Security**: Werkzeug password hashing, session-based authentication\n- **File Uploads**: Pillow for image processing\n\n## Project Structure\n```\n/YourEmpire\n├── app.py                          # Main Flask application\n├── users.json                      # User data and wallets\n├── packages.json                   # Available packages\n├── payments.json                   # Payment history\n├── withdraws.json                  # Withdrawal requests\n├── ads.json                        # Ad data\n├── ad_views.json                   # Ad view tracking\n├── settings.json                   # System settings & payment methods\n├── templates/                      # HTML templates\n│   ├── index.html                 # Landing page\n│   ├── register.html              # User registration\n│   ├── login.html                 # Login page\n│   ├── forgot_password.html       # Password reset request\n│   ├── user_dashboard.html        # User dashboard\n│   ├── buy_package.html           # Package purchase form\n│   ├── withdraw.html              # Withdrawal request form\n│   ├── watch_ads.html             # Ad watching interface\n│   ├── admin_dashboard.html       # Admin control panel\n│   ├── manage_ads.html            # Ad management\n│   └── change_admin_password.html # Admin password change\n├── static/\n│   ├── uploads/                   # Payment screenshots\n│   └── ads/                       # Ad media files\n└── replit.md                      # This file\n```\n\n## Default Login Credentials\n- **Admin Email**: admin@yourempire.com\n- **Admin Password**: admin123\n- **Note**: Change admin password immediately after first login\n\n## Default Settings\n- Commission Percentage: 50%\n- Minimum Withdrawal: 225 PKR\n- Ads Enabled: Yes\n- Default Payment Methods: Easypaisa, JazzCash, Bank Account (with sample details)\n\n## Packages\n1. **Bronze**: 450 PKR\n2. **Silver**: 1000 PKR\n3. **Diamond**: 1250 PKR\n4. **Platinum**: 2000 PKR\n\n## How It Works\n\n### Referral Commission Flow\n1. User A registers and gets referral code (e.g., YE1234)\n2. User B registers using User A's referral code\n3. User B buys a package and submits payment\n4. Admin approves the payment\n5. User A automatically receives 50% commission in their wallet\n\n### Ad Rewards Flow\n1. Admin uploads an ad (video/image/link) with a reward amount\n2. Admin enables the ad section for users\n3. User views/clicks the ad\n4. Reward is automatically credited to user's wallet\n5. Each ad can only be claimed once per day per user\n\n### Withdrawal Flow\n1. User requests withdrawal (minimum 225 PKR)\n2. Admin reviews and approves the request\n3. Amount is automatically deducted from user's wallet\n4. Admin processes payment to user's account\n\n## Admin-Controlled Payment Methods\nThe admin can manage payment methods that users see when purchasing packages:\n- Add new payment methods (Easypaisa, JazzCash, Bank Account)\n- Edit account numbers and account names\n- Delete payment methods\n- All payment details are displayed to users during package purchase\n\n## Security Features\n- Password hashing with Werkzeug PBKDF2\n- Session-based authentication\n- File upload validation (5MB limit)\n- Secure file naming\n- Admin-only routes protected by decorators\n\n## Design\n- Purple-blue gradient theme\n- Fully responsive (mobile and desktop)\n- Modern card-based UI\n- TailwindCSS utility classes\n- Glass-morphism effects\n\n## Running the Application\n\n### Local Development\nThe Flask server runs on port 5000:\n```bash\npython app.py\n```\nAccess at: http://localhost:5000\n\n### Deployment to Render\nFor step-by-step deployment instructions with PostgreSQL database, see **DEPLOYMENT_GUIDE.md**\n\nQuick Summary:\n1. Create `requirements.txt`, `Procfile`, `runtime.txt` ✅ (Already created)\n2. Push code to GitHub\n3. Create PostgreSQL database on Render\n4. Deploy Flask app on Render\n5. Add environment variables\n6. Initialize database\n7. Access your live app!\n\n## Recent Changes\n- 2025-11-21: Completed migration from JSON to PostgreSQL database\n- Enhanced registration with full_name, phone, city, address fields\n- Master Admin system implemented with full authority over admins\n- Profile update requests with admin approval workflow\n- Referral tree viewing for users and admins\n- Announcements and guide videos system added\n- Login history tracking implemented\n- Password reset system (Master Admin controlled)\n- Created deployment files for Render: Procfile, runtime.txt, requirements.txt\n- All templates updated with responsive design\n- Ad watching system with daily limits implemented\n- Referral commission system with automatic wallet updates\n\n## Notes\n- All data is stored locally in JSON files\n- No external APIs or databases required\n- 100% offline operation\n- Made with ❤️ by YourEmpire\n","size_bytes":6818},"main.py":{"content":"def main():\n    print(\"Hello from repl-nix-workspace!\")\n\n\nif __name__ == \"__main__\":\n    main()\n","size_bytes":96},"init_db.py":{"content":"#!/usr/bin/env python\nimport os\nimport json\nfrom app import app, db\nfrom models import User, Admin, MasterAdmin, Package, PaymentMethod, Settings, Ad, Payment, Withdrawal, AdView\nfrom werkzeug.security import generate_password_hash\n\ndef migrate_from_json():\n    \"\"\"Migrate existing JSON data to PostgreSQL\"\"\"\n    \n    with app.app_context():\n        # Create all tables\n        db.create_all()\n        \n        print(\"Starting data migration from JSON to PostgreSQL...\")\n        \n        # Load JSON files\n        users_data = load_json_file('users.json', [])\n        packages_data = load_json_file('packages.json', [])\n        settings_data = load_json_file('settings.json', {})\n        payments_data = load_json_file('payments.json', [])\n        withdraws_data = load_json_file('withdraws.json', [])\n        ads_data = load_json_file('ads.json', [])\n        ad_views_data = load_json_file('ad_views.json', [])\n        \n        # Create Master Admin\n        master_admin_email = 'masteradmin@yourempire.com'\n        if not MasterAdmin.query.filter_by(email=master_admin_email).first():\n            master_admin = MasterAdmin(email=master_admin_email)\n            master_admin.set_password('Master@lihyder1866')\n            db.session.add(master_admin)\n            print(f\"✓ Created Master Admin: {master_admin_email}\")\n        else:\n            master_admin = MasterAdmin.query.filter_by(email=master_admin_email).first()\n            print(f\"✓ Master Admin already exists: {master_admin_email}\")\n        \n        db.session.commit()\n        \n        # Migrate Users\n        user_id_map = {}\n        for user_data in users_data:\n            if not User.query.filter_by(email=user_data['email']).first():\n                user = User(\n                    email=user_data['email'],\n                    full_name=user_data.get('name', user_data['email']),\n                    phone=user_data.get('phone', '+92XXXXXXXXXX'),\n                    city=user_data.get('city', 'Not specified'),\n                    address=user_data.get('address', ''),\n                    referral_code=user_data['referral_code'],\n                    wallet_balance=user_data.get('wallet', 0.0),\n                    is_invested=user_data.get('is_invested', False)\n                )\n                user.password_hash = user_data['password']\n                user_id_map[user_data['id']] = None\n                db.session.add(user)\n                print(f\"✓ Migrated user: {user_data['email']}\")\n        \n        db.session.commit()\n        \n        # Update referrals\n        for user_data in users_data:\n            user = User.query.filter_by(email=user_data['email']).first()\n            if user and user_data.get('referred_by'):\n                referrer = User.query.filter_by(referral_code=user_data.get('referred_by', '')).first()\n                if referrer:\n                    user.referred_by = referrer.id\n                    print(f\"✓ Set referral for {user.email} -> {referrer.email}\")\n        \n        db.session.commit()\n        \n        # Migrate Packages\n        for pkg_data in packages_data:\n            if not Package.query.filter_by(name=pkg_data['name']).first():\n                package = Package(\n                    name=pkg_data['name'],\n                    price=pkg_data['price']\n                )\n                db.session.add(package)\n                print(f\"✓ Migrated package: {pkg_data['name']}\")\n        \n        db.session.commit()\n        \n        # Migrate Payment Methods\n        for pm_data in settings_data.get('payment_methods', []):\n            if not PaymentMethod.query.filter_by(account_number=pm_data['account_number']).first():\n                pm = PaymentMethod(\n                    type=pm_data['type'],\n                    account_number=pm_data['account_number'],\n                    account_name=pm_data['account_name'],\n                    bank_name=pm_data.get('bank_name', '')\n                )\n                db.session.add(pm)\n                print(f\"✓ Migrated payment method: {pm_data['type']}\")\n        \n        # Add Default Payment Methods if not already present\n        default_methods = [\n            {'type': 'Easypaisa', 'account_number': '03001234567', 'account_name': 'YourEmpire Business'},\n            {'type': 'JazzCash', 'account_number': '03015678901', 'account_name': 'YourEmpire Official'},\n            {'type': 'Sadapay', 'account_number': 'sadapay@yourempire', 'account_name': 'YourEmpire Sadapay'},\n            {'type': 'Bank Account', 'account_number': '1234567890123', 'account_name': 'YourEmpire Ltd', 'bank_name': 'HBL'}\n        ]\n        \n        for method in default_methods:\n            if not PaymentMethod.query.filter_by(type=method['type']).first():\n                pm = PaymentMethod(\n                    type=method['type'],\n                    account_number=method['account_number'],\n                    account_name=method['account_name'],\n                    bank_name=method.get('bank_name', '')\n                )\n                db.session.add(pm)\n                print(f\"✓ Created default payment method: {method['type']}\")\n        \n        db.session.commit()\n        \n        # Migrate Settings\n        settings_map = {\n            'commission_percentage': settings_data.get('commission_percentage', 50),\n            'min_withdrawal': settings_data.get('min_withdrawal', 225),\n            'ads_enabled': settings_data.get('ads_enabled', True)\n        }\n        \n        for key, value in settings_map.items():\n            if not Settings.query.filter_by(key=key).first():\n                setting = Settings(key=key, value=str(value))\n                db.session.add(setting)\n                print(f\"✓ Migrated setting: {key}\")\n        \n        db.session.commit()\n        \n        # Migrate Ads\n        for ad_data in ads_data:\n            if not Ad.query.filter_by(title=ad_data.get('title', '')).first():\n                ad = Ad(\n                    title=ad_data.get('title', ''),\n                    type=ad_data.get('type', 'image'),\n                    media_file=ad_data.get('media_file'),\n                    link=ad_data.get('link'),\n                    reward=ad_data.get('reward', 0)\n                )\n                db.session.add(ad)\n                print(f\"✓ Migrated ad: {ad_data.get('title', 'Unknown')}\")\n        \n        db.session.commit()\n        \n        print(\"\\n✅ Data migration completed successfully!\")\n        print(\"\\nDefault Credentials:\")\n        print(f\"Master Admin Email: {master_admin_email}\")\n        print(f\"Master Admin Password: Master@lihyder1866\")\n        print(\"\\nTo create regular admins, log in to Master Admin dashboard.\")\n\ndef load_json_file(filename, default):\n    \"\"\"Load JSON file safely\"\"\"\n    try:\n        with open(filename, 'r') as f:\n            return json.load(f)\n    except (FileNotFoundError, json.JSONDecodeError):\n        return default\n\nif __name__ == '__main__':\n    migrate_from_json()\n","size_bytes":6942},"DEPLOYMENT_GUIDE.md":{"content":"# YourEmpire - Deployment to Render (Simple Guide)\n\n## What is Render?\nRender is a cloud platform where you can host your web app and database for free/paid. It's like hosting your app on the internet so anyone can access it.\n\n---\n\n## STEP 1: Prepare Your App for Deployment\n\n### 1.1 Create a `requirements.txt` file\nThis file tells Render what packages your app needs.\n\nCreate a new file called `requirements.txt` in your root folder with this content:\n\n```\nFlask==3.0.0\nFlask-SQLAlchemy==3.1.1\npsycopg2-binary==2.9.11\npython-dotenv==1.0.0\nWerkzeug==3.0.1\nPillow==10.1.0\ngunicorn==21.2.0\n```\n\n### 1.2 Create a `runtime.txt` file\nThis tells Render which Python version to use.\n\nCreate file `runtime.txt` with:\n```\npython-3.11.7\n```\n\n### 1.3 Create a `Procfile` file\nThis tells Render how to start your app.\n\nCreate file `Procfile` with:\n```\nweb: gunicorn app:app\n```\n\n### 1.4 Update `app.py` - Add this line at the TOP after all imports:\n```python\nimport os\n\n# Add this line to allow running on different hosts:\napp.config['ENV'] = 'production'\n```\n\n---\n\n## STEP 2: Create Render Account\n\n1. Go to **https://render.com**\n2. Click **\"Sign Up\"** (top right)\n3. Sign up with:\n   - Email: Your email\n   - Password: Create a strong password\n   - OR use GitHub/Google to sign up\n4. Verify your email\n\n---\n\n## STEP 3: Push Your Code to GitHub (REQUIRED)\n\nRender needs your code on GitHub to deploy it.\n\n### 3.1 Create a GitHub Repository\n1. Go to **https://github.com** and log in (or create account)\n2. Click **\"+\"** (top right) → **\"New repository\"**\n3. Name it: `yourempire`\n4. Make it **PUBLIC** (important!)\n5. Click **\"Create repository\"**\n\n### 3.2 Upload Your Code to GitHub\n\nIn Replit terminal, run these commands:\n\n```bash\ncd /home/runner/workspace\n\n# Initialize git\ngit init\n\n# Add all files\ngit add .\n\n# Create first commit\ngit commit -m \"Initial YourEmpire deployment\"\n\n# Add GitHub as remote (replace YOUR_USERNAME and repo name)\ngit remote add origin https://github.com/YOUR_USERNAME/yourempire.git\n\n# Push to GitHub\ngit branch -M main\ngit push -u origin main\n```\n\n**Note:** Replace `YOUR_USERNAME` with your actual GitHub username.\n\n---\n\n## STEP 4: Create PostgreSQL Database on Render\n\n1. Go back to **https://render.com** (logged in)\n2. Click **\"+ New +\"** button (top right)\n3. Select **\"PostgreSQL\"**\n4. Fill in:\n   - **Name:** `yourempire-db`\n   - **Database:** `yourempire`\n   - **User:** `admin`\n   - **Region:** Choose closest to you\n   - **PostgreSQL Version:** 15\n5. Click **\"Create Database\"**\n6. **WAIT** 2-3 minutes for database to be created\n7. Once created, you'll see a **Connection String** - **COPY THIS AND SAVE IT SOMEWHERE SAFE**\n\nThe connection string looks like:\n```\npostgresql://admin:PASSWORD@hostname:5432/yourempire\n```\n\n---\n\n## STEP 5: Deploy Your Flask App on Render\n\n1. Go to **https://render.com** (logged in)\n2. Click **\"+ New +\"** button (top right)\n3. Select **\"Web Service\"**\n4. Connect GitHub:\n   - Click **\"Connect account\"**\n   - Authorize Render to access GitHub\n   - Select repository: `yourempire`\n5. Fill in settings:\n   - **Name:** `yourempire-app`\n   - **Environment:** `Python 3`\n   - **Build Command:** `pip install -r requirements.txt`\n   - **Start Command:** `gunicorn app:app`\n   - **Region:** Same as your database\n6. Click **\"Create Web Service\"**\n\n---\n\n## STEP 6: Add Environment Variables\n\nAfter creating the service:\n\n1. On Render dashboard, click your `yourempire-app` service\n2. Go to **\"Environment\"** tab (left sidebar)\n3. Click **\"Add Environment Variable\"**\n4. Add these variables:\n\n| Key | Value |\n|-----|-------|\n| `DATABASE_URL` | Paste the connection string from Step 4 |\n| `FLASK_ENV` | `production` |\n| `SECRET_KEY` | Generate random string (use: `python -c \"import secrets; print(secrets.token_hex(32))\"`) |\n| `SESSION_SECRET` | Same as SECRET_KEY |\n\n5. Click **\"Save\"**\n\n---\n\n## STEP 7: Deploy Your App\n\nAfter adding environment variables:\n\n1. The app will automatically start deploying\n2. Go to **\"Logs\"** tab to watch deployment\n3. **WAIT** 3-5 minutes for deployment to complete\n4. Once you see: `\"Listening on port 10000\"` - it's LIVE! ✅\n5. Click the URL at the top to visit your app\n\n---\n\n## STEP 8: Initialize Database on Render\n\nYour database is empty. You need to create tables and add default data.\n\n### Option A: Use Python Script (Easiest)\n\n1. In Replit, run this in the terminal:\n```bash\n# Connect to Render database and initialize\npython -c \"\nimport os\nos.environ['DATABASE_URL'] = 'PASTE_YOUR_CONNECTION_STRING_HERE'\nfrom app import app, db\nwith app.app_context():\n    db.create_all()\n    print('Database created!')\n\"\n```\n\nReplace `PASTE_YOUR_CONNECTION_STRING_HERE` with your actual connection string.\n\n### Option B: Use Render Shell\n1. On Render dashboard, go to your database service\n2. Click **\"Connect\"**\n3. Click **\"Using psql\"**\n4. Copy the command and run in terminal\n5. Then run: `\\q` to exit\n\n---\n\n## STEP 9: Test Your Live App\n\n1. Click the URL given by Render (looks like: `https://yourempire-app.onrender.com`)\n2. You should see your YourEmpire homepage! 🎉\n3. Test:\n   - Click **\"Register\"** - try creating account\n   - Click **\"Login\"** - try logging in with existing account\n   - Test **\"Admin\"** - try Master Admin login with:\n     - Email: `masteradmin@yourempire.com`\n     - Password: `Master@lihyder1866`\n\n---\n\n## STEP 10: Update Code (In Future)\n\nWhenever you update code in Replit:\n\n```bash\ncd /home/runner/workspace\ngit add .\ngit commit -m \"Your message here\"\ngit push origin main\n```\n\nRender will automatically redeploy your app within 1-2 minutes!\n\n---\n\n## TROUBLESHOOTING\n\n### App shows \"Service Unavailable\"\n- Check logs on Render dashboard\n- Wait 5 more minutes\n- Restart service (Settings → Restart)\n\n### Database connection error\n- Check `DATABASE_URL` environment variable is correct\n- Make sure database is running (check Render dashboard)\n\n### App runs locally but not on Render\n- Make sure all required packages are in `requirements.txt`\n- Check that `Procfile` is correct\n- Check `gunicorn` command works\n\n---\n\n## IMPORTANT NOTES\n\n✅ **Free Plan Includes:**\n- 1 web service\n- 1 PostgreSQL database\n- Auto-sleep if no traffic (free tier)\n\n⚠️ **Important:**\n- Render free tier apps sleep after 15 mins of no activity (restart automatically when accessed)\n- Free database is limited to 90 days - then you need to add payment method\n- Keep your GitHub repo updated\n\n---\n\n## Need Help?\n\nCommon Issues & Solutions:\n\n| Problem | Solution |\n|---------|----------|\n| App won't deploy | Check `Procfile` and `requirements.txt` |\n| Database won't connect | Verify `DATABASE_URL` in Environment |\n| Registration not working | Check database was initialized |\n| Admin login fails | Make sure database has Master Admin data |\n\n---\n\n**That's it! Your app is now LIVE on the internet!** 🚀\n","size_bytes":6814},"models.py":{"content":"from flask_sqlalchemy import SQLAlchemy\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\nimport random\nimport string\n\ndb = SQLAlchemy()\n\nclass User(db.Model):\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(255), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    full_name = db.Column(db.String(255), nullable=False)\n    phone = db.Column(db.String(20), nullable=False)\n    city = db.Column(db.String(255), nullable=False)\n    address = db.Column(db.Text, nullable=True)\n    referral_code = db.Column(db.String(10), unique=True, nullable=False)\n    referred_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)\n    wallet_balance = db.Column(db.Float, default=0.0)\n    is_invested = db.Column(db.Boolean, default=False)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    referred_users = db.relationship('User', remote_side='User.id')\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n    \n    @staticmethod\n    def generate_referral_code():\n        while True:\n            code = f\"YE{random.randint(1000, 9999)}\"\n            if not User.query.filter_by(referral_code=code).first():\n                return code\n\nclass MasterAdmin(db.Model):\n    __tablename__ = 'master_admin'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(255), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\nclass Admin(db.Model):\n    __tablename__ = 'admins'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(255), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    created_by_master_id = db.Column(db.Integer, db.ForeignKey('master_admin.id'), nullable=False)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\nclass Package(db.Model):\n    __tablename__ = 'packages'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(255), nullable=False)\n    price = db.Column(db.Float, nullable=False)\n    description = db.Column(db.Text, nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass Payment(db.Model):\n    __tablename__ = 'payments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    package_id = db.Column(db.Integer, db.ForeignKey('packages.id'), nullable=False)\n    amount = db.Column(db.Float, nullable=False)\n    payment_method_id = db.Column(db.Integer, db.ForeignKey('payment_methods.id'), nullable=False)\n    transaction_id = db.Column(db.String(255), nullable=True)\n    screenshot = db.Column(db.String(255), nullable=True)\n    status = db.Column(db.String(20), default='Pending')  # Pending, Approved, Rejected\n    approved_by_admin_id = db.Column(db.Integer, db.ForeignKey('admins.id'), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='payments')\n    package = db.relationship('Package')\n    admin = db.relationship('Admin')\n\nclass Withdrawal(db.Model):\n    __tablename__ = 'withdrawals'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    amount = db.Column(db.Float, nullable=False)\n    payment_method = db.Column(db.String(100), nullable=False)\n    account_number = db.Column(db.String(255), nullable=False)\n    account_name = db.Column(db.String(255), nullable=False)\n    status = db.Column(db.String(20), default='Pending')  # Pending, Approved, Rejected\n    approved_by_admin_id = db.Column(db.Integer, db.ForeignKey('admins.id'), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='withdrawals')\n    admin = db.relationship('Admin')\n\nclass PaymentMethod(db.Model):\n    __tablename__ = 'payment_methods'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    type = db.Column(db.String(100), nullable=False)  # Easypaisa, JazzCash, Bank Account\n    account_number = db.Column(db.String(255), nullable=False)\n    account_name = db.Column(db.String(255), nullable=False)\n    bank_name = db.Column(db.String(255), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass Ad(db.Model):\n    __tablename__ = 'ads'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(255), nullable=False)\n    type = db.Column(db.String(50), nullable=False)  # video, image, link\n    media_file = db.Column(db.String(255), nullable=True)\n    link = db.Column(db.String(255), nullable=True)\n    reward = db.Column(db.Float, nullable=False)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass AdView(db.Model):\n    __tablename__ = 'ad_views'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    ad_id = db.Column(db.Integer, db.ForeignKey('ads.id'), nullable=False)\n    viewed_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User')\n    ad = db.relationship('Ad')\n\nclass Settings(db.Model):\n    __tablename__ = 'settings'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    key = db.Column(db.String(255), unique=True, nullable=False)\n    value = db.Column(db.Text, nullable=False)\n\nclass Announcement(db.Model):\n    __tablename__ = 'announcements'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    type = db.Column(db.String(50), nullable=False)  # text, image, video\n    content = db.Column(db.Text, nullable=False)\n    media_file = db.Column(db.String(255), nullable=True)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass GuideVideo(db.Model):\n    __tablename__ = 'guide_videos'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(255), nullable=False)\n    video_url = db.Column(db.String(255), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass PasswordResetRequest(db.Model):\n    __tablename__ = 'password_reset_requests'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    status = db.Column(db.String(20), default='Pending')  # Pending, Resolved\n    requested_at = db.Column(db.DateTime, default=datetime.utcnow)\n    resolved_by_master_admin_id = db.Column(db.Integer, db.ForeignKey('master_admin.id'), nullable=True)\n    resolved_at = db.Column(db.DateTime, nullable=True)\n    new_password_hash = db.Column(db.String(255), nullable=True)\n    \n    user = db.relationship('User')\n    master_admin = db.relationship('MasterAdmin')\n\nclass ProfileUpdateRequest(db.Model):\n    __tablename__ = 'profile_update_requests'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    update_type = db.Column(db.String(50), nullable=False)  # phone, city, address, password\n    new_value = db.Column(db.Text, nullable=False)\n    status = db.Column(db.String(20), default='Pending')  # Pending, Approved, Rejected\n    approved_by_admin_id = db.Column(db.Integer, db.ForeignKey('admins.id'), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User')\n    admin = db.relationship('Admin')\n\nclass LoginHistory(db.Model):\n    __tablename__ = 'login_history'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)\n    admin_id = db.Column(db.Integer, db.ForeignKey('admins.id'), nullable=True)\n    master_admin_id = db.Column(db.Integer, db.ForeignKey('master_admin.id'), nullable=True)\n    login_type = db.Column(db.String(20), nullable=False)  # user, admin, master\n    ip_address = db.Column(db.String(50), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n","size_bytes":9092},"QUICK_DEPLOY_STEPS.md":{"content":"# 🚀 YourEmpire - QUICK DEPLOYMENT STEPS\n\n## ⚡ TL;DR - Deploy in 10 Minutes\n\n### 1️⃣ PREPARE (2 minutes)\n- ✅ Files already ready: `Procfile`, `runtime.txt`, `requirements.txt`\n\n### 2️⃣ GITHUB (3 minutes)\n```bash\n# In Replit terminal:\ncd /home/runner/workspace\ngit init\ngit add .\ngit commit -m \"Initial deployment\"\ngit remote add origin https://github.com/YOUR_USERNAME/yourempire.git\ngit branch -M main\ngit push -u origin main\n```\n\n### 3️⃣ RENDER DATABASE (2 minutes)\n- Go to **render.com**\n- Click **\"+ New +\"** → **\"PostgreSQL\"**\n- Name: `yourempire-db`\n- Database: `yourempire`\n- User: `admin`\n- Copy CONNECTION STRING when done\n\n### 4️⃣ RENDER APP (2 minutes)\n- Click **\"+ New +\"** → **\"Web Service\"**\n- Connect GitHub → Select `yourempire` repo\n- Build Command: `pip install -r requirements.txt`\n- Start Command: `gunicorn app:app`\n- Click Create\n\n### 5️⃣ ENVIRONMENT VARIABLES (1 minute)\nIn Render dashboard, go to your app → Environment:\n```\nDATABASE_URL = [PASTE CONNECTION STRING FROM STEP 3]\nFLASK_ENV = production\nSECRET_KEY = [generate: python -c \"import secrets; print(secrets.token_hex(32))\"]\nSESSION_SECRET = [same as SECRET_KEY]\n```\n\n### 6️⃣ DONE! ✅\n- Wait 5 minutes for deployment\n- Click the live URL\n- Your app is LIVE! 🎉\n\n---\n\n## 📚 Need Detailed Help?\nSee **DEPLOYMENT_GUIDE.md** for complete step-by-step guide with screenshots and troubleshooting.\n\n---\n\n## 🔑 Login Credentials\n\n**Master Admin:**\n- Email: `masteradmin@yourempire.com`\n- Password: `Master@lihyder1866`\n\n**Existing User:**\n- Email: `alihyderrohani3@gmail.com`\n- Password: (same as before)\n\n---\n\n## ⚠️ Important Notes\n- Your GitHub repo must be PUBLIC\n- Free tier Render apps sleep after 15 mins (restart auto when accessed)\n- Free database expires after 90 days (add payment to continue)\n\n**That's it! You're deployed!** 🚀\n","size_bytes":1865}},"version":2}